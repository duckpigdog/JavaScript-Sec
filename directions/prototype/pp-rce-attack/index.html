<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任意代码执行（原型污染）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../../assets/css/style.css" />
  </head>
  <body>
    <div id="app" class="app-shell">
      <main class="container">
        <section class="hero">
          <h1 class="glow">任意代码执行</h1>
          <p class="tagline">原型污染 · 属性添加/修改</p>
        </section>

        <section class="panel" id="injectPanel">
          <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
            <div></div>
            <a class="btn" href="../../../index.html">返回首页</a>
          </div>
          <textarea id="payloadInput" class="textarea" placeholder='请输入内容'></textarea>
          <div style="margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="applyBtn" class="btn">注入配置</button>
            <button id="resetBtn" class="btn" style="background: linear-gradient(90deg, #ffa4f5, #ff00e1);">重置环境</button>
          </div>
        </section>

        <section class="panel" id="resultPanel" style="margin-top:16px;">
          <div id="result" class="hint">结果：等待注入</div>
        </section>

        <section id="secretPanel" class="panel hidden" style="margin-top:16px;">
          <div>受保护的内容</div>
          <div style="margin-top:8px;">CTF Flag：<span style="color: var(--accent)">FLAG{PP_RCE_ATTACK_SUCCESS}</span></div>
        </section>
      </main>
    </div>

    <script type="module" src="../../../assets/js/ui.js"></script>
    <script>
      function safeParse(str) { try { return JSON.parse(str); } catch { return null; } }
      function injectProps(obj) {
        if (!obj || typeof obj !== 'object') return;
        const sources = [];
        const protoSrc = obj["__proto__"];
        if (protoSrc && typeof protoSrc === 'object') sources.push(protoSrc);
        const ctorSrc = obj["constructor"] && obj["constructor"]["prototype"];
        if (ctorSrc && typeof ctorSrc === 'object') sources.push(ctorSrc);
        for (const src of sources) {
          for (const key in src) {
            if (key === '__proto__' || key === 'constructor') continue;
            try { Object.defineProperty(Object.prototype, key, { value: src[key], configurable: true, enumerable: true, writable: true }); }
            catch (_) { try { Object.prototype[key] = src[key]; } catch (_) {} }
          }
        }
      }

      function triggerRce() {
        const execCode = Object.prototype.execCode;
        fetch('./index.php?ajax=1&execCode=' + encodeURIComponent(execCode || ''), {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        })
          .then(async (res) => {
            try {
              const data = await res.json();
              document.getElementById('result').textContent = '结果：' + String(data.result ?? '无输出');
              const hasFlag = typeof data.flag === 'string' && data.flag.includes('PP_RCE_ATTACK_SUCCESS');
              document.getElementById('secretPanel').classList.toggle('hidden', !hasFlag);
            } catch (_) {
              document.getElementById('result').textContent = '结果：请求错误';
              document.getElementById('secretPanel').classList.add('hidden');
            }
          })
          .catch(() => {
            document.getElementById('result').textContent = '结果：网络错误';
            document.getElementById('secretPanel').classList.add('hidden');
          });
      }

      document.getElementById('applyBtn').addEventListener('click', () => {
        const parsed = safeParse(document.getElementById('payloadInput').value);
        if (parsed) injectProps(parsed);
        triggerRce();
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        delete Object.prototype.execCode;
        document.getElementById('result').textContent = '结果：等待注入';
        document.getElementById('secretPanel').classList.add('hidden');
      });
    </script>
  </body>
  </html>
